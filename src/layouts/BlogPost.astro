---
import { type CollectionEntry, render } from "astro:content";

import Masthead from "@/components/blog/Masthead.astro";
import TOC from "@/components/blog/TOC.astro";
import WebMentions from "@/components/blog/webmentions/index.astro";

import BaseLayout from "./Base.astro";

interface Props {
	post: CollectionEntry<"post">;
}

const { post } = Astro.props;
const { ogImage, title, description, updatedDate, publishDate } = post.data;
const socialImage = ogImage ?? `/og-image/${post.id}.png`;
const articleDate = updatedDate?.toISOString() ?? publishDate.toISOString();
const { headings, remarkPluginFrontmatter } = await render(post);
const readingTime: string = remarkPluginFrontmatter.readingTime;
---

<BaseLayout
  meta={{
    articleDate,
    description,
    ogImage: socialImage,
    title,
  }}>
  <article class="grow break-words" data-pagefind-body>
    <div id="blog-hero" class="mb-12">
      <Masthead content={post} readingTime={readingTime} />
    </div>
    {!!headings.length && <TOC headings={headings} />}
    <div class="prose max-w-none">
      <slot />
      <WebMentions />
    </div>
  </article>

  <!-- Back to top - minimal text button -->
  <button
    class="fixed end-4 bottom-8 z-90 translate-y-28 cursor-pointer text-sm text-text-secondary opacity-0 transition-all duration-300 hover:text-global-text data-[show=true]:translate-y-0 data-[show=true]:opacity-100 sm:end-8"
    data-show="false"
    id="to-top-btn">
    <span>â†‘ Top</span>
  </button>
</BaseLayout>

<script>
  const scrollBtn = document.getElementById("to-top-btn") as HTMLButtonElement;
  const targetHeader = document.getElementById("blog-hero") as HTMLDivElement;

  function callback(entries: IntersectionObserverEntry[]) {
    entries.forEach((entry) => {
      scrollBtn.dataset.show = (!entry.isIntersecting).toString();
    });
  }

  scrollBtn.addEventListener("click", () => {
    document.documentElement.scrollTo({ behavior: "smooth", top: 0 });
  });

  const observer = new IntersectionObserver(callback);
  observer.observe(targetHeader);
</script>

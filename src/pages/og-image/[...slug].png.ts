export const prerender = true;

import AtkinsonHyperlegibleBold from "@/assets/fonts/AtkinsonHyperlegible-Bold.ttf";
import AtkinsonHyperlegible from "@/assets/fonts/AtkinsonHyperlegible-Regular.ttf";
import { getAllPosts } from "@/data/post";
import { siteConfig } from "@/site.config";
import { getFormattedDate } from "@/utils/date";
import { Resvg } from "@resvg/resvg-js";
import type { APIContext, InferGetStaticPropsType } from "astro";
import satori, { type SatoriOptions } from "satori";
import { html } from "satori-html";

const ogOptions: SatoriOptions = {
  // debug: true,
  fonts: [
    {
      data: Buffer.from(AtkinsonHyperlegible),
      name: "Atkinson Hyperlegible",
      style: "normal",
      weight: 400,
    },
    {
      data: Buffer.from(AtkinsonHyperlegibleBold),
      name: "Atkinson Hyperlegible Bold",
      style: "normal",
      weight: 700,
    },
  ],
  height: 630,
  width: 1200,
};

const markup = (title: string, pubDate: string) =>
  html`<div tw="flex flex-col w-full h-full bg-[#1d1f21] text-[#c9cacc]">
    <div tw="flex flex-col flex-1 w-full p-10 justify-center">
      <p tw="text-2xl mb-6">${pubDate}</p>
      <h1 tw="text-6xl font-bold leading-snug text-white">${title}</h1>
    </div>
    <div
      tw="flex items-center justify-between w-full p-10 border-t border-[#2bbc89] text-xl">
      <div tw="flex items-center">
        <svg
          width="60"
          height="60"
          viewBox="0 0 1246 1259"
          fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path
            fill="#327567"
            d="M923.07 990.57c-7.3 4.61-14.51 9.34-21.9 13.8-29.3 17.69-58.66 35.3-88 52.94-12 7.21-23.93 14.51-36.04 21.51-1.46.84-4.32.76-5.8-.12-41.9-25-83.7-50.15-125.54-75.26-5.93-3.56-12.16-6.69-17.84-10.62-2.97-2.05-5.02-1.48-7.57.05-12.14 7.28-24.32 14.48-36.46 21.76-22.57 13.55-44.13 27.14-66.68 40.72-12.69 7.64-25.39 15.27-38.05 22.95-2.58 1.56-4.59 1.94-7.63.11-47.58-28.65-95.29-57.1-142.96-85.61-1.13-.68-2.17-1.5-3.05-2.75 49.6-30.12 99-59.76 149.28-89.92-2.87-1.87-4.48-3-6.17-4.01-45.66-27.4-91.33-54.78-136.96-82.23-2.04-1.23-3.69-3.11-5.21-4.85 49.71-29.79 99.1-59.43 148.79-88.89 21.11 12.74 41.9 25.33 62.74 37.83 27.69 16.62 55.41 33.19 83.15 49.73 1.18.71 2.65.94 4.33 1.33 2.26-1.06 4.23-1.97 6.07-3.08 47.82-28.65 95.62-57.33 143.71-85.81 21.74 13.04 43.18 25.89 64.62 38.76 28.03 16.82 56.06 33.64 83.95 50.75-1.86 1.56-3.47 3-5.3 4.1-45.4 27.28-90.83 54.52-136.24 81.79-2.06 1.24-4.02 2.66-6.76 4.49 2.53 1.65 4.24 2.87 6.04 3.94 45.7 27.42 91.42 54.82 137.1 82.28 1.95 1.17 3.59 2.84 5.37 4.28z" />
          <path
            fill="#5DE4C7"
            d="M474 720c-49.4 29.64-98.79 59.28-149.77 89.01-.77.04-.96-.01-1.16-.52-.02-59.47-.02-118.47-.02-178.46-50.74 30.41-100.29 60.12-149.85 89.83-.06-15.83-.16-31.65-.16-47.48.02-42.65-.02-85.31.06-127.96 0-3.56.72-5.56 4.25-7.64 25.84-15.23 51.37-30.98 77.08-46.42 22.78-13.69 45.67-27.21 68.73-40.93v-5.32c0-56.65.02-113.3-.05-169.95 0-3.37.6-5.3 4.02-7.32 30.83-18.23 61.4-36.92 92.12-55.36 17.63-10.59 35.39-20.97 53.49-31.93.39 59.81.39 119.12.39 179.45 10.8-6.46 20.49-12.24 30.16-18.05 39.94-24 79.87-48.02 119.96-71.95.4.15.58.29.49.89-.34 2.71-.56 5.03-.57 7.35-.02 57.26-.03 114.51-.33 171.93-48.34 29.01-96.39 57.86-144.41 86.75-1.64.99-3 2.45-4.71 4.07-.34 2.7-.55 5.02-.55 7.34-.02 57.23-.02 114.45-.03 171.68z" />
          <path
            fill="#CAFFF4"
            d="M624 450c0-57.26 0-114.51.03-171.77 0-2.32.23-4.64.9-7.14 49.71 29.3 98.86 58.78 149.11 88.92V180.16c7.37 4.16 14.83 8.18 22.1 12.51 17.57 10.46 35.07 21.05 52.58 31.61 22.76 13.72 45.34 27.76 68.38 40.98 5.76 3.31 7.08 6.83 7.05 12.93-.23 55.64.09 111.29-.24 166.93 0 3.45 1.19 5.27 3.91 6.89 27.56 16.33 55.11 32.69 82.63 49.1 20.06 11.96 40.08 23.98 60.09 36.01 2.43 1.46 3.61 3.32 3.6 6.64-.17 58.14-.12 116.29-.51 174.98-7.38-3.57-14.42-7.63-21.38-11.81-41.19-24.7-82.37-49.42-123.56-74.12-1.32-.79-2.74-1.44-4.74-2.48v60.25c0 59.28 0 118.57-.23 177.91-.23.09-.71.17-.71.17-28.03-16.82-56.06-33.65-84.09-50.47-21.44-12.86-42.89-25.72-64.62-39.23-.29-58.47-.28-116.28-.31-174.1 0-1.94-.42-3.88-.91-6.06-26.56-16.04-52.87-31.83-79.18-47.62-23.3-13.98-46.6-27.96-69.91-41.94z" />
          <path
            fill="#48AF99"
            d="M773.66 180.1c.36 59.57.36 119.09.36 179.9-50.25-30.14-99.4-59.62-148.89-89.31-.46-.42-.64-.56-1.01-.9-.13-.27-.06-.64-.06-.64 33.72-20.26 67.42-40.57 101.18-60.77 15.96-9.55 32.03-18.89 48.42-28.28zM923.93 809.14v-178.82c2.01 1.04 3.42 1.69 4.74 2.48 41.19 24.7 82.37 49.42 123.56 74.12 6.97 4.18 14 8.24 21.36 12.29-2.04 1.91-4.24 4.23-6.88 5.82-41.29 24.92-82.62 49.77-123.97 74.59-5.92 3.55-11.95 6.92-18.32 10.19-.42-.34-.46-.5-.49-.67zM623.71 269.07c.36.08.28.45.25.64-39.96 24.2-79.89 48.22-119.83 72.22-9.67 5.81-19.36 11.59-30.16 18.05V180.58c7.38 3.73 14.89 7.77 22.2 12.14 25.89 15.47 51.71 31.07 77.58 46.59 16.53 9.92 33.09 19.79 50 29.76zM174.25 720.19c49.48-30.04 99.04-59.75 149.77-90.16v178.75c-.08.95-.09 1.15-.11 1.34-14.03-8.27-28.1-16.48-42.07-24.84-24.31-14.54-48.57-29.17-72.85-43.78-11.57-6.97-23.11-13.97-34.74-21.31zM323.96 810.57c-.03-.65-.01-.85.06-1.34.24-.24.42-.19.88-.08 2.11 1.64 3.75 3.52 5.79 4.75 45.63 27.45 91.31 54.83 136.96 82.23 1.68 1.01 3.3 2.14 6.17 4.01-50.27 30.16-99.67 59.8-149.36 89.59-.35-9.5-.45-19.16-.46-28.81-.02-49.96-.01-99.92-.04-150.35zM923.7 809.23c.27.08.31.24.38.65-.01 58.02-.04 115.79-.09 173.56 0 2.16-.18 4.31-.6 6.8-2.1-1.11-3.75-2.78-5.69-3.95-45.68-27.46-91.4-54.86-137.1-82.28-1.8-1.08-3.52-2.29-6.04-3.94 2.74-1.83 4.7-3.25 6.76-4.49 45.41-27.27 90.84-54.51 136.24-81.79 1.82-1.09 3.44-2.54 5.3-4.1.14-.28.62-.37.84-.46zM474.27 720.18c-.29-57.41-.28-114.64-.26-171.87 0-2.32.22-4.64.9-7.17 50.08 29.48 99.59 59.17 149.09 89.33 0 32.08-.02 63.69 0 95.31.02 27.78.09 55.57.14 83.35-1.33-.45-2.8-.68-3.98-1.39-27.74-16.54-55.46-33.11-83.15-49.73-20.84-12.51-41.63-25.1-62.74-37.83zM624.49 809.07c-.4-27.72-.47-55.51-.49-83.29-.02-31.61 0-63.23.3-95.47 39.57-24.19 78.85-47.71 118.08-71.32 10.4-6.26 20.63-12.79 30.93-19.19.23 1.94.65 3.88.65 5.82.03 57.82.03 115.63.02 173.91-47.81 29.14-95.61 57.81-143.43 86.46-1.85 1.11-3.81 2.01-6.06 3.08zM773.07 539.55c-10.05 6.65-20.28 13.18-30.68 19.44-39.23 23.61-78.51 47.13-118.07 70.85-49.81-29.53-99.32-59.22-149.18-89.08 1.14-1.41 2.5-2.87 4.14-3.86 48.02-28.89 96.06-57.73 144.41-86.75 23.6 13.82 46.91 27.8 70.21 41.78 26.31 15.79 52.61 31.58 79.17 41.62z" />
        </svg>
        <p tw="ml-3 font-semibold">${siteConfig.title}</p>
      </div>
      <p>by ${siteConfig.author}</p>
    </div>
  </div>`;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

export async function GET(context: APIContext) {
  const { pubDate, title } = context.props as Props;

  const postDate = getFormattedDate(pubDate, {
    month: "long",
    weekday: "long",
  });
  const svg = await satori(markup(title, postDate), ogOptions);
  const png = new Resvg(svg).render().asPng();
  return new Response(png, {
    headers: {
      "Cache-Control": "public, max-age=31536000, immutable",
      "Content-Type": "image/png",
    },
  });
}

export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts
    .filter(({ data }) => !data.ogImage)
    .map((post) => ({
      params: { slug: post.id },
      props: {
        pubDate: post.data.updatedDate ?? post.data.publishDate,
        title: post.data.title,
      },
    }));
}

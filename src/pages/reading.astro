---
import BaseLayout from "@/layouts/Base.astro";
import Schema from "@/components/Schema.astro";
import { influentialBooks, GOODREADS_RSS_URL, GOODREADS_PROFILE_URL } from "@/data/books";

const meta = {
  title: "Reading",
  description: "Books that shaped my thinking.",
};

// Flatten books for collection schema
const bookCollectionItems = influentialBooks.flatMap(cat =>
  cat.books.map(book => ({
    name: book.title,
    description: `by ${book.author}${book.note ? ` — ${book.note}` : ""}`,
  }))
);

// Fetch currently reading from Goodreads RSS at build time
interface GoodreadsBook {
  title: string;
  author: string;
  link?: string;
}

let currentlyReading: GoodreadsBook[] = [];

try {
  const response = await fetch(GOODREADS_RSS_URL);
  if (response.ok) {
    const xml = await response.text();
    // Parse RSS items using string methods
    const items = xml.split("<item>").slice(1);

    for (const item of items) {
      const endIndex = item.indexOf("</item>");
      const itemContent = endIndex > -1 ? item.substring(0, endIndex) : item;

      // Extract title from CDATA
      const titleStart = itemContent.indexOf("<title><![CDATA[");
      const titleEnd = itemContent.indexOf("]]></title>");
      const title = titleStart > -1 && titleEnd > -1
        ? itemContent.substring(titleStart + 16, titleEnd)
        : null;

      // Extract author
      const authorStart = itemContent.indexOf("<author_name>");
      const authorEnd = itemContent.indexOf("</author_name>");
      const author = authorStart > -1 && authorEnd > -1
        ? itemContent.substring(authorStart + 13, authorEnd)
        : "Unknown";

      // Extract link
      const linkStart = itemContent.indexOf("<link>");
      const linkEnd = itemContent.indexOf("</link>");
      const link = linkStart > -1 && linkEnd > -1
        ? itemContent.substring(linkStart + 6, linkEnd)
        : undefined;

      if (title) {
        currentlyReading.push({ title, author, link });
      }
    }
  }
} catch (error) {
  console.warn("Failed to fetch Goodreads RSS:", error);
}

// Fallback if RSS fails
if (currentlyReading.length === 0) {
  currentlyReading = [
    {
      title: "The Almanack of Naval Ravikant",
      author: "Eric Jorgenson",
      link: "https://www.navalmanack.com/",
    },
  ];
}
---

<BaseLayout meta={meta}>
  <Schema
    type="collection"
    title={meta.title}
    description={meta.description}
    collectionName="Book Recommendations"
    collectionItems={bookCollectionItems}
  />
  <Schema type="breadcrumb" breadcrumbs={[
    { name: "Home", url: "/" },
    { name: "Reading", url: "/reading/" }
  ]} />
  <article>
    <header class="mb-12">
      <h1 class="page-title">Reading</h1>
      <p class="mt-2 text-text-secondary">Books that shaped my thinking. I read slowly and re-read often.</p>
    </header>

    {/* Currently Reading — from Goodreads RSS with ruler-notch */}
    <section class="mb-12">
      <div class="section-rule"><span>Currently Reading</span></div>
      <ul class="space-y-2">
        {currentlyReading.map((book) => (
          <li class="ruler-notch">
            <div class="post-row">
              {book.link ? (
                <a class="post-title link" href={book.link} target="_blank" rel="noopener noreferrer">
                  {book.title}
                </a>
              ) : (
                <span class="post-title">{book.title}</span>
              )}
              <span class="post-leader"></span>
              <span class="post-date mono">{book.author}</span>
            </div>
          </li>
        ))}
      </ul>
    </section>

    {/* Influential Books — from static data with № index for Favorites */}
    {influentialBooks.map((category, categoryIndex) => (
      <section class="mb-12">
        <div class="section-rule"><span>{category.title}</span></div>
        <ul class="space-y-3">
          {category.books.map((book, bookIndex) => (
            <li>
              <div class="post-row">
                {categoryIndex === 0 ? (
                  <span class="idx">{String(bookIndex + 1).padStart(2, "0")}</span>
                ) : null}
                <span class="post-title font-medium">{book.title}</span>
                <span class="post-leader"></span>
                <span class="post-date mono">{book.author}</span>
              </div>
              {book.note && (
                <p class="mt-0.5 text-text-tertiary pl-0" style={`font-size: var(--text-micro); ${categoryIndex === 0 ? 'padding-left: 2.5rem;' : ''}`}>
                  {book.note}
                </p>
              )}
            </li>
          ))}
        </ul>
      </section>
    ))}

    {/* Link to full Goodreads */}
    <nav class="mt-12">
      <a class="arrow-link" href={GOODREADS_PROFILE_URL} target="_blank" rel="noopener noreferrer">
        View full library on Goodreads <span aria-hidden="true">→</span>
      </a>
    </nav>

  </article>
</BaseLayout>

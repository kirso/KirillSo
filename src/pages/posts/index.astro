---
import FormattedDate from "@/components/FormattedDate.astro";
import { getAllPosts, getUniqueTags, groupPostsByYear, sortPostsByPinnedAndDate } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";
import Schema from "@/components/Schema.astro";

const MAX_POSTS_PER_PAGE = 10;
const MAX_TAGS = 10;
const allPosts = await getAllPosts();
const uniqueTags = getUniqueTags(allPosts).slice(0, MAX_TAGS);
const sortedPosts = sortPostsByPinnedAndDate(allPosts).slice(0, MAX_POSTS_PER_PAGE);
const totalPosts = allPosts.length;

const meta = {
	description: "Read my collection of posts and the things that interest me",
	title: "Posts",
};

const groupedByYear = groupPostsByYear(sortedPosts);
const descYearKeys = Object.keys(groupedByYear).sort((a, b) => +b - +a);
---

<PageLayout meta={meta}>
  <Schema type="breadcrumb" breadcrumbs={[
    { name: "Home", url: "/" },
    { name: "Blog", url: "/posts/" }
  ]} />
  <header class="mb-8">
    <h1 class="page-title">Posts</h1>
    <p class="mt-2 text-text-secondary">{totalPosts} posts published</p>
  </header>

  {/* Topics — Horizontal tag row */}
  {
    !!uniqueTags.length && (
      <nav class="mb-12 flex flex-wrap items-center gap-3 border-y border-border py-4" style="font-size: var(--text-micro);">
        <span class="text-text-tertiary uppercase tracking-wide">Topics</span>
        {uniqueTags.map((tag) => (
          <a class="tag" href={`/tags/${tag}/`}>#{tag}</a>
        ))}
        <a class="arrow-link ml-auto" href="/tags/">all →</a>
      </nav>
    )
  }

  {/* Posts by year */}
  <main>
    {
      descYearKeys.map((yearKey) => (
        <section class="mb-12" aria-labelledby={`year-${yearKey}`}>
          <div class="section-rule" id={`year-${yearKey}`}>
            <span>{yearKey}</span>
          </div>
          <ul class="space-y-1">
            {groupedByYear[yearKey]?.map((p) => (
              <li class="post-row">
                <a class="post-title link" data-astro-prefetch href={`/posts/${p.id}/`}>
                  {p.data.pinned && <span class="text-text-tertiary" title="Pinned">↑ </span>}
                  {p.data.title}
                </a>
                <span class="post-leader"></span>
                <span class="post-date mono">
                  <FormattedDate date={p.data.publishDate} />
                </span>
              </li>
            ))}
          </ul>
        </section>
      ))
    }
    {
      sortedPosts.length >= MAX_POSTS_PER_PAGE && (
        <nav class="mt-12">
          <a class="arrow-link" href="/posts/page/2/">
            Next page <span aria-hidden="true">→</span>
          </a>
        </nav>
      )
    }
  </main>
</PageLayout>

---
import { Image } from "astro:assets";
import { type CollectionEntry, getCollection } from "astro:content";
import Card from "@/components/Card.astro";
import FormattedDate from "@/components/FormattedDate.astro";
import Note from "@/components/note/Note.astro";
import { getAllPosts } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";
import headshot from "@/assets/img/headshot.png";

// Posts
const MAX_POSTS = 10;
const allPosts = await getAllPosts();
const allPostsByDate = allPosts
  .sort(collectionDateSort)
  .slice(0, MAX_POSTS) as CollectionEntry<"post">[];

// Notes
const MAX_NOTES = 3;
const allNotes = await getCollection("note");
const latestNotes = allNotes.sort(collectionDateSort).slice(0, MAX_NOTES);

// Projects
const projects = [
  {
    title: "Keepsake",
    to: "https://www.makekeepsake.com",
    description: "Preserve your family memories",
  },
  {
    title: "Google clone",
    to: "/posts/google-clone/",
    description: "Search with Google API",
  },
  {
    title: "Panic theme",
    to: "https://github.com/kirso/logseq-panic-theme",
    description: "Make Logseq PKM pretty",
  },
  {
    title: "Schwiftyverse",
    to: "https://schwiftyverse.vercel.app/",
    description: "GIFs on Solana blockchain",
  },
];
---

<PageLayout meta={{ title: "Home" }}>
  <!-- Hero with subtle dot-grid texture -->
  <header class="dot-grid border-border-light mb-12 border p-6">
    <div class="flex flex-col gap-6 sm:flex-row sm:items-start sm:gap-8">
      <Image
        src={headshot}
        alt="Kirill So"
        loading="eager"
        class="h-24 w-24 shrink-0 rounded-full object-cover grayscale"
      />
      <div class="text-text-secondary flex-1">
        <p class="leading-relaxed">
          Hi, I'm Kirill. Currently on sabbatical and in exploration mode.
          Previously, I was a principal product manager at Delivery Hero, where
          I shipped growth features that drove millions in revenue.
        </p>
        <p class="mt-4 leading-relaxed">
          I write about life experiences and digital products. In my free time I
          weightlift, play tennis, and travel with my <a
            class="link font-medium"
            href="https://sarahkhanamajid.com/"
            target="_blank"
            rel="noopener">wife</a
          >.
        </p>
        <nav
          class="mt-6 flex flex-wrap gap-x-4 gap-y-2"
          style="font-size: var(--text-micro);"
        >
          <a
            class="link"
            href="https://twitter.com/kirso_"
            target="_blank"
            rel="noopener">Twitter</a
          >
          <span class="text-text-tertiary">/</span>
          <a
            class="link"
            href="https://github.com/kirso"
            target="_blank"
            rel="noopener">GitHub</a
          >
          <span class="text-text-tertiary">/</span>
          <a
            class="link"
            href="https://www.linkedin.com/in/kirso"
            target="_blank"
            rel="noopener">LinkedIn</a
          >
          <span class="text-text-tertiary">/</span>
          <a
            class="link"
            href="https://kirill.substack.com"
            target="_blank"
            rel="noopener">Newsletter</a
          >
          <span class="text-text-tertiary">/</span>
          <a
            class="link"
            href="https://www.kirillso.com/resume.pdf"
            target="_blank"
            rel="noopener">CV</a
          >
        </nav>
      </div>
    </div>
  </header>

  <!-- Posts -->
  <section class="mb-16">
    <div class="mb-6 flex items-center gap-4">
      <div class="section-rule !mb-0 flex-1"><span>Posts</span></div>
      <a class="arrow-link shrink-0" href="/posts/">
        View all <span aria-hidden="true">→</span>
      </a>
    </div>
    <ul class="space-y-1">
      {
        allPostsByDate.map((p) => (
          <li class="post-row">
            <a
              class="post-title link"
              data-astro-prefetch
              href={`/posts/${p.id}/`}
            >
              {p.data.pinned && (
                <span class="text-text-tertiary" title="Pinned">
                  ↑{" "}
                </span>
              )}
              {p.data.draft && (
                <span class="text-amber-600 dark:text-amber-400" title="Draft">
                  [draft]{" "}
                </span>
              )}
              {p.data.title}
            </a>
            <span class="post-leader" />
            <span class="post-date mono">
              <FormattedDate date={p.data.publishDate} />
            </span>
          </li>
        ))
      }
    </ul>
  </section>

  <!-- Notes -->
  {
    latestNotes.length > 0 && (
      <section class="mb-16">
        <div class="mb-6 flex items-center gap-4">
          <div class="section-rule !mb-0 flex-1">
            <span>Notes</span>
          </div>
          <a class="arrow-link shrink-0" href="/notes/">
            View all <span aria-hidden="true">→</span>
          </a>
        </div>
        <ul class="space-y-6">
          {latestNotes.map((note) => (
            <li>
              <Note note={note} as="h3" isPreview />
            </li>
          ))}
        </ul>
      </section>
    )
  }

  <!-- Projects -->
  <section>
    <div class="section-rule"><span>Projects</span></div>
    <div class="divide-border border-border divide-y border">
      {projects.map((project) => <Card {...project} />)}
    </div>
  </section>
</PageLayout>
